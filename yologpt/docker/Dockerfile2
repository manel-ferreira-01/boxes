ARG USER=worker
ARG GROUP=workers
ARG WORKSPACE=/workspace

# ------------------------------
# Final image to run the service
# ------------------------------

FROM python:3.10-slim 
# Renew build args
ARG USER
ARG GROUP
ARG WORKSPACE
ARG PROTO_FILE
ARG SRC_DIR

WORKDIR ${WORKSPACE}/

# Install OS dependencies
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

RUN pip install --upgrade pip && \
    pip install grpcio grpcio-tools protobuf opencv-python

# Create non-privileged user to run
RUN addgroup --system ${GROUP} && \
    adduser --system --ingroup ${GROUP} ${USER} && \
    chown -R ${USER}:${GROUP} ${WORKSPACE}

# Change to non-privileged user
USER ${USER}

ENV HOME=/home/${USER}

# Expose port 8061 according to ai4eu specifications
EXPOSE 8061 7860

WORKDIR ${WORKSPACE}/

CMD ["python", "yoloservice.py"]
